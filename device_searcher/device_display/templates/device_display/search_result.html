<!--@author wychengpublic-->
{% extends "device_display/home.html" %}

{% load staticfiles %}

{% block css %}
<link href="{% static 'display/self_defined/css/search_result.css' %}" rel="stylesheet">
{% endblock %}

{% block main_container %}
<form role="form">
    <div class="form-group row" id="search-group">
        <div class="col-sm-5" id="div_input">
            <input type="text" id="searchtext" name="search_text" value="{{ search_text }}" class="form-control"
                   pattern="[^\\,;]+" required oninvalid="setCustomValidity('搜索内容不能为空，且不包含特殊字符(\\，；)。')"
                   oninput="setCustomValidity('')">
            <input type="hidden" id="searchcat" name="search_category" value="{{ search_category }}">
            <input type="hidden" name="page_index" value="{{ page_index }}">
            <input type="hidden" id="page_total" value="{{ page_total }}">
            <input type="hidden" id="searchtext_last" value="{{ search_text }}">
        </div>
        <div class="col-sm-1" id="div_btn">
            <button type="button" id="btn_search" class="btn btn-sm btn-primary btn-block">搜索</button>
        </div>
    </div>
</form>
<ul class="nav nav-tabs" id="nav_result_cat">
    <li class="cat" id="cat_type"><a data-toggle="tab">类型</a></li>
    <li class="cat" id="cat_brand"><a data-toggle="tab">品牌</a></li>
    <li class="cat" id="cat_model"><a data-toggle="tab">型号</a></li>
    <li class="cat" id="cat_fingerprint"><a data-toggle="tab">指纹</a></li>
</ul>
<!--切换结果分类标签的active状态-->
<script>
    $('#nav_result_cat').children().removeClass('active');
    var cat = $('#searchcat').val();
    switch (cat) {
        case 'type' :
            $('#cat_type').addClass('active');
            break;
        case 'brand' :
            $('#cat_brand').addClass('active');
            break;
        case 'model' :
            $('#cat_model').addClass('active');
            break;
        case 'fingerprint' :
            $('#cat_fingerprint').addClass('active');
            break;
    }
</script>

{% include "device_display/result.html" %}
<script src="{% static 'display/self_defined/js/search_result.js' %}"></script>
<script>
    // post to get search_results
    function get_results(search_text, search_category, page_index) {
        var url = "{% url 'display:search' %}";
        $.post(url,
            {
                'search_text': search_text,
                'search_category': search_category,
                'page_index': page_index
            },
            function (data, status) {
                if (status === 'success') {
                    alert('success!,参数：' + search_text + "," + search_category + "," + page_index);
                    // 记录上次搜索成功的关键词，以便下次搜索输入框为空时，作为默认关键词提交
                    $('input#searchtext_last').val(search_text);
                    var result_json = eval('(' + data + ')');
                    show_intable(result_json);
                    // 因为show_intable函数可能改变总页码，所以需要再次调整页码显示
                    var input_page_total = $("input#page_total");
                    var input_page_index = $("input[name='page_index']");
                    adjust_pages(input_page_total, input_page_index, get_results_post);
                } else {
                    // 显示错误信息到页面
                    alert('请求失败了……');
                }
            });
    }
    // post to delete
    function delete_row(ids_list, delete_category) {
        var url = "{% url 'display:delete_record' %}";
        $.post(url,
            {
                'id_list': ids_list,
                'delete_category': delete_category
            },
            function (data, status) {
                if (status === 'success') {
                    var result_json = eval('(' + data + ')');

                    var failure_id_list = result_json.failure;
                    var suc_len = ids_list.length - failure_id_list.length;
                    //
                    alert("删除成功：" + suc_len + " " + " 删除失败：" + failure_id_list.length + failure_id_list);
                    // 更新当前页（重新取一遍当前页数的数据，并将失败的条目标红几秒钟fade

                } else {
                    // 显示错误信息到页面
                    alert('请求失败了……');
                }
            });
    }
    // post to edit
    function edit_row(row_list, delete_category) {
        var url = "{% url 'display:edit_record' %}";

        $.post(url,
            {
                'list_len': row_list.length,
                'row_list': row_list,
                'delete_category': delete_category
            },
            function (data, status) {
                if (status === 'success') {
                    alert('修改成功了');
                    var result_json = eval('(' + data + ')');
                    var list_success = result_json.sucess;
                    var ind;
                    // 将修改成功的内容回显
                    for (ind in list_success) {
                        var id = list_success[ind][0];
                        var row_fields = $("input[type = 'checkbox'][value = " + id + "]").parent().siblings();
                        row_fields.each(function (index, element) {
                            $(this).html(list_success[ind][index + 1]);
                        });
                    }
                }
                else {
                    // 显示错误信息到页面
                    alert('请求失败了……');
                }
            }
        );
    }

    // post to export
    function export_result(search_text, search_category) {
        var url = "{% url 'display:export_record' %}";
        $.post(url,
            {
                'search_text': search_text,
                'search_category': search_category
            },
            function (data, status) {
                if (status === 'success') {
                    alert("导出请求发送成功!");
                } else {
                    alert("导出请求失败...");
                }
            }
        );
    }

    // post to add_record
    function add_record(add_category, record) {
        var url = "{% url 'display:add_record' %}";
        alert(record);
        $.post(url,
            {
                'add_category': add_category,
                'record': record
            }, function (data, status) {
                if (status === 'success') {
                    alert("添加请求发送成功!");
                } else {
                    alert("添加请求失败...");
                }
            });
    }

</script>
{% endblock %}